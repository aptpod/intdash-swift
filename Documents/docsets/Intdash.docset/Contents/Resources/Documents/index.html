<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Intdash  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>
    <a title="Intdash  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html">Intdash v1.0.2 Docs</a></p>
        <p class="header-right">
          <form role="search" action="search.json">
            <input type="text" placeholder="Search documentation" data-typeahead>
          </form>
        </p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html">Intdash Reference</a>
        <img id="carat" src="img/carat.png" />
        Intdash  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/CANUtils.html">CANUtils</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/GeneralSensorUtils.html">GeneralSensorUtils</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient.html">IntdashClient</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/Session.html">– Session</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/DataPointsAPI.html">– DataPointsAPI</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/EdgesAPI.html">– EdgesAPI</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/DownstreamManager.html">– DownstreamManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/UpstreamManager.html">– UpstreamManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/OAuth2API.html">– OAuth2API</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/CapturesAPI.html">– CapturesAPI</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/MeasurementsAPI.html">– MeasurementsAPI</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashClient/VersionsAPI.html">– VersionsAPI</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData.html">IntdashData</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataAAC.html">– DataAAC</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataBaseTime.html">– DataBaseTime</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataBytes.html">– DataBytes</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataCAN.html">– DataCAN</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataControlPad.html">– DataControlPad</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataFloat.html">– DataFloat</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataGeneralSensor.html">– DataGeneralSensor</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataGeneric.html">– DataGeneric</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataH264.html">– DataH264</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataH265.html">– DataH265</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataInt.html">– DataInt</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataJPEG.html">– DataJPEG</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataMavlinkPacket.html">– DataMavlinkPacket</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataNMEA.html">– DataNMEA</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataPCM.html">– DataPCM</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashData/DataString.html">– DataString</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashDataFileManager.html">IntdashDataFileManager</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashLog.html">IntdashLog</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/IntdashPacketHelper.html">IntdashPacketHelper</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/NMEAUtils.html">NMEAUtils</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/NTPManager.html">NTPManager</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Global%20Variables.html">Global Variables</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Global%20Variables.html#/s:7Intdash01kA16FrameworkVersionSSvp">kIntdashFrameworkVersion</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/Endian.html">Endian</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/FactorType.html">FactorType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IntdashDataType.html">IntdashDataType</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/IntdashLogLevel.html">IntdashLogLevel</a>
              </li>
              <li class="nav-group-task">
                <a href="Enums/NMEADataType.html">NMEADataType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Extensions.html">Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Extensions/Date.html">Date</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/GeneralSensorConvertible.html">GeneralSensorConvertible</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IntdashClientDelegate.html">IntdashClientDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IntdashClientDownstreamManagerDelegate.html">IntdashClientDownstreamManagerDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/IntdashClientUpstreamManagerDelegate.html">IntdashClientUpstreamManagerDelegate</a>
              </li>
              <li class="nav-group-task">
                <a href="Protocols/NMEA.html">NMEA</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Structs.html">Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Structs/CaptureItem.html">CaptureItem</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/CapturesListResponse.html">CapturesListResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/CapturesPage.html">CapturesPage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DataPoint.html">DataPoint</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/DataPointsGetDataPointsResponse.html">DataPointsGetDataPointsResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EdgeItem.html">EdgeItem</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EdgesListResponse.html">EdgesListResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EdgesMePasswordResponse.html">EdgesMePasswordResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/EdgesPage.html">EdgesPage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorAcceleration.html">GeneralSensorAcceleration</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorAccelerationIncludingGravity.html">GeneralSensorAccelerationIncludingGravity</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorGeoLocationAccuracy.html">GeneralSensorGeoLocationAccuracy</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorGeoLocationAltitude.html">GeneralSensorGeoLocationAltitude</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorGeoLocationCoordinate.html">GeneralSensorGeoLocationCoordinate</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorGeoLocationHeading.html">GeneralSensorGeoLocationHeading</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorGeoLocationSpeed.html">GeneralSensorGeoLocationSpeed</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorGravity.html">GeneralSensorGravity</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorOrientationAngle.html">GeneralSensorOrientationAngle</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/GeneralSensorRotationRate.html">GeneralSensorRotationRate</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IntdashClientDownstreamManagerError.html">IntdashClientDownstreamManagerError</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IntdashClientDownstreamManagerError/Kind.html">– Kind</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IntdashClientUpstreamManagerError.html">IntdashClientUpstreamManagerError</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IntdashClientUpstreamManagerError/Kind.html">– Kind</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/IntdashVersion.html">IntdashVersion</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MeasurementItem.html">MeasurementItem</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MeasurementsListResponse.html">MeasurementsListResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/MeasurementsPage.html">MeasurementsPage</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/NMEARMC.html">NMEARMC</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/OAuth2AuthenticateResponse.html">OAuth2AuthenticateResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RESTError.html">RESTError</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RESTError/Kind.html">– Kind</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/RealtimeDataPoint.html">RealtimeDataPoint</a>
              </li>
              <li class="nav-group-task">
                <a href="Structs/VersionsGetVersionInfoResponse.html">VersionsGetVersionInfoResponse</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Typealiases.html">Type Aliases</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:7Intdash15EdgesMeResponsea">EdgesMeResponse</a>
              </li>
              <li class="nav-group-task">
                <a href="Typealiases.html#/s:7Intdash21OAuth2RefreshResponsea">OAuth2RefreshResponse</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='intdash-sdk-for-swift' class='heading'>intdash SDK for Swift</h1>

<p><a href="https://docs.intdash.jp/sdk/swift/latest/">ドキュメントホーム</a></p>
<h2 id='このsdkを使用するために必要な開発環境' class='heading'>■ このSDKを使用するために必要な開発環境</h2>

<ul>
<li>Xcode 11.3以上</li>
</ul>
<h2 id='動作環境' class='heading'>■ 動作環境</h2>

<ul>
<li>iOS 12以上</li>
</ul>
<h2 id='事前準備' class='heading'>■ 事前準備</h2>

<p>1. intdashサーバーの管理者からOAuth2.0のクライアントIDを入手します。<br>
（例：<code>abcdefg123456</code>）<br>
2. これから開発するアプリケーションのコールバックスキーム名を決め、intdashサーバーの管理者へスキーム名の登録を依頼してください。<br>
（例： <code>companyname.appname</code>）<br>
3. <code>Info.plist</code> の <code>URL Types</code>で、以下のようにコールバックスキームを登録します。<br>
例)</p>
<pre class="highlight plaintext"><code>|Key                |Type       |Value                             |
|-------------------|-----------|----------------------------------|
|- URL types        |Array      |                                  |
| - Item 0 (Viewer) |Dictionary |                                  |
|  - Document Role  |String     |Viewer                            |
|  - URL identifier |String     |$(PRODUCT_BUNDLE_IDENTIFIER)      |
|  - URL Schemes    |Array      |                                  |
|   - Item 0        |String     |スキーム名（例：companyname.appname）   |
</code></pre>

<p>4. <code>Intdash.xcframework</code> をプロジェクトに追加します。  </p>

<p>※ 手動で開発するプロジェクトへフレームワークを追加した場合は <code>Embed &amp; Sign</code> としてください。</p>
<h3 id='cocoapods' class='heading'>Cocoapods</h3>

<p>このフレームワークは <a href="http://cocoapods.org">CocoaPods</a> からも入手可能です、<code>Podfile</code> に以下を追加してください。</p>
<pre class="highlight ruby"><code><span class="n">pod</span> <span class="s1">'Intdash'</span>
</code></pre>
<h2 id='実装' class='heading'>■ 実装</h2>
<h3 id='認証' class='heading'>・認証</h3>

<p>1. フレームワークをインポートする。<br>
2. <code><a href="Classes/IntdashClient/Session.html">IntdashClient.Session</a></code> を初期化する。<br>
3. <code><a href="Classes/IntdashClient/OAuth2API.html">IntdashClient.OAuth2API</a></code> を初期化する。<br>
4. Web認証用URLを生成する。<br>
5. 認証を開始する。<br>
6. 認証結果が正しいかチェックする。<br>
7. 正常に認証ができていれば認証コードを利用してアクセストークンを取得する。<br>
8. 必要に応じて、サインインしたエッジ（自分自身）の情報を取得する。  </p>
<pre class="highlight swift"><code><span class="c1">// 1. フレームワークをインポートする。</span>
<span class="kd">import</span> <span class="kt">Intdash</span>
<span class="kd">import</span> <span class="kt">AuthenticationServices</span>

<span class="c1">// intdashサーバー名</span>
<span class="k">let</span> <span class="nv">kTargetServer</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"https://example.com"</span>
<span class="c1">// OAuth2.0 クライアントID</span>
<span class="k">let</span> <span class="nv">kIntdashClientId</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"abcdefg123456"</span>
<span class="c1">// コールバックスキームを使用したコールバックURL</span>
<span class="k">let</span> <span class="nv">kCallbackURLScheme</span><span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"companyname.appname://oauth2/callback"</span>

<span class="kd">class</span> <span class="kt">ExampleViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

    <span class="k">var</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">Session</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">signInEdgeUuid</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
    <span class="k">var</span> <span class="nv">signInEdgeName</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>

    <span class="kd">private</span> <span class="k">var</span> <span class="nv">webAuthSession</span><span class="p">:</span> <span class="kt">NSObject</span><span class="p">?</span>

    <span class="kd">func</span> <span class="nf">signIn</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">#available(iOS 12.0, *)</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Unsupported OS"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="c1">// 2. `IntdashClient.Session` を初期化する。</span>
        <span class="k">let</span> <span class="nv">session</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">Session</span><span class="p">(</span><span class="nv">serverURL</span><span class="p">:</span> <span class="n">kTargetServer</span><span class="p">,</span> <span class="nv">clientId</span><span class="p">:</span> <span class="n">kIntdashClientId</span><span class="p">)</span>
        <span class="k">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="c1">// 3. `IntdashClient.OAuth2API` を初期化する。</span>
        <span class="k">let</span> <span class="nv">oauth2Api</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">OAuth2API</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
        <span class="c1">// 4. Web認証用URLを生成する。</span>
        <span class="k">let</span> <span class="nv">callbackURLScheme</span> <span class="o">=</span> <span class="n">kCallbackURLScheme</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">":"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"%3A"</span><span class="p">)</span><span class="o">.</span><span class="nf">replacingOccurrences</span><span class="p">(</span><span class="nv">of</span><span class="p">:</span> <span class="s">"/"</span><span class="p">,</span> <span class="nv">with</span><span class="p">:</span> <span class="s">"%2F"</span><span class="p">)</span> <span class="c1">// URLエンコード</span>
        <span class="n">oauth2Api</span><span class="o">.</span><span class="nf">generateAuthorizationURL</span><span class="p">(</span><span class="nv">callbackURLScheme</span><span class="p">:</span> <span class="n">callbackURLScheme</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">codeVerifier</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="k">let</span> <span class="nv">url</span> <span class="o">=</span> <span class="n">url</span><span class="p">,</span> <span class="k">let</span> <span class="nv">authURL</span> <span class="o">=</span> <span class="kt">URL</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">url</span><span class="p">),</span> <span class="k">let</span> <span class="nv">codeVerifier</span> <span class="o">=</span> <span class="n">codeVerifier</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"generateAuthorizationURL failed. </span><span class="se">\(</span><span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="c1">// 5. 認証を開始する。</span>
            <span class="k">let</span> <span class="nv">webAuthSession</span> <span class="o">=</span> <span class="kt">ASWebAuthenticationSession</span><span class="p">(</span><span class="nv">url</span><span class="p">:</span> <span class="n">authURL</span><span class="p">,</span> <span class="nv">callbackURLScheme</span><span class="p">:</span> <span class="n">kCallbackURLScheme</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">callbackURL</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">guard</span> <span class="n">error</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">,</span> <span class="k">let</span> <span class="nv">callbackURL</span> <span class="o">=</span> <span class="n">callbackURL</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Web authentication callback error. </span><span class="se">\(</span><span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                <span class="c1">// 6. 認証結果が正しいかチェックする。</span>
                <span class="k">var</span> <span class="nv">result</span> <span class="o">=</span> <span class="kc">false</span>
                <span class="k">var</span> <span class="nv">code</span><span class="p">:</span> <span class="kt">String</span><span class="p">?</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">queryItems</span> <span class="o">=</span> <span class="kt">URLComponents</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="n">callbackURL</span><span class="o">.</span><span class="n">absoluteString</span><span class="p">)?</span><span class="o">.</span><span class="n">queryItems</span> <span class="p">{</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">queryItems</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"state"</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">state</span> <span class="p">{</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"code"</span> <span class="p">{</span>
                            <span class="n">code</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">code</span> <span class="o">=</span> <span class="n">code</span><span class="p">,</span> <span class="n">result</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Web authentication was successful."</span><span class="p">)</span>
                    <span class="c1">// 7. 正常に認証ができていれば認証コードを利用してアクセストークンを取得する。</span>
                    <span class="c1">// (※このとき `IntdashClient.Session` の認証情報はフレームワーク側で自動で更新されます。)</span>
                    <span class="n">oauth2Api</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="nv">code</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span> <span class="nv">codeVerifier</span><span class="p">:</span> <span class="n">codeVerifier</span><span class="p">,</span> <span class="nv">callbackURLScheme</span><span class="p">:</span> <span class="n">kCallbackURLScheme</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                            <span class="nf">print</span><span class="p">(</span><span class="s">"requestAccessToken failed. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                            <span class="k">return</span>
                        <span class="p">}</span>
                        <span class="c1">// 8. 必要に応じて、サインインしたエッジ（自分自身）の情報を取得する。</span>
                        <span class="c1">// (※このあとデータのアップストリームを行う場合はエッジのUUIDが必要です。)</span>
                        <span class="k">let</span> <span class="nv">edgesApi</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">EdgesAPI</span><span class="p">(</span><span class="nv">session</span><span class="p">:</span> <span class="n">session</span><span class="p">)</span>
                        <span class="n">edgesApi</span><span class="o">.</span><span class="n">me</span> <span class="p">{</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                            <span class="k">guard</span> <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="n">response</span> <span class="k">else</span> <span class="p">{</span>
                                <span class="nf">print</span><span class="p">(</span><span class="s">"requestEdgesMe failed. </span><span class="se">\(</span><span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                                <span class="k">return</span>
                            <span class="p">}</span>
                            <span class="nf">print</span><span class="p">(</span><span class="s">"Successful sign-in."</span><span class="p">)</span>
                            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">signInEdgeName</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">name</span>
                            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">signInEdgeUuid</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">uuid</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="kd">#available(iOS 13.0, *)</span> <span class="p">{</span>
                <span class="n">webAuthSession</span><span class="o">.</span><span class="n">presentationContextProvider</span> <span class="o">=</span> <span class="k">self</span>
                <span class="n">webAuthSession</span><span class="o">.</span><span class="n">prefersEphemeralWebBrowserSession</span> <span class="o">=</span> <span class="kc">false</span>
            <span class="p">}</span>

            <span class="c1">// Start</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">webAuthSession</span> <span class="o">=</span> <span class="n">webAuthSession</span>
            <span class="n">webAuthSession</span><span class="o">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ExampleViewController</span><span class="p">:</span> <span class="kt">ASWebAuthenticationPresentationContextProviding</span> <span class="p">{</span>

    <span class="kd">@available</span><span class="p">(</span><span class="n">iOS</span> <span class="mf">12.0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
    <span class="kd">func</span> <span class="nf">presentationAnchor</span><span class="p">(</span><span class="k">for</span> <span class="nv">session</span><span class="p">:</span> <span class="kt">ASWebAuthenticationSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">ASPresentationAnchor</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kt">UIApplication</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">first</span> <span class="p">??</span> <span class="kt">ASPresentationAnchor</span><span class="p">()</span>
    <span class="p">}</span>

<span class="p">}</span>


</code></pre>
<h3 id='エッジ-計測-キャプチャーなどintdash-apiが提供するリソースの取得' class='heading'>・エッジ、計測、キャプチャーなどintdash APIが提供するリソースの取得</h3>

<p>例として、ここではエッジの一覧を取得します。</p>

<p>1. <code><a href="Classes/IntdashClient.html">IntdashClient</a></code> を初期化する。<br>
2. 認証情報がセットされた <code><a href="Classes/IntdashClient/Session.html">IntdashClient.Session</a></code> をセットする。<br>
3. エッジの一覧を取得する。  </p>
<pre class="highlight swift"><code><span class="c1">// 1. IntdashClientを初期化する。</span>
<span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="p">()</span>

<span class="c1">// 2. 認証情報がセットされた `IntdashClient.Session` をセットする。</span>
<span class="n">intdash</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">session</span>

<span class="c1">// 3. エッジの一覧を取得する。</span>
<span class="n">intdash</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">list</span> <span class="p">{</span> <span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">response</span> <span class="o">=</span> <span class="n">response</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"requestEdgeList failed. </span><span class="se">\(</span><span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"successful request for edge list. </span><span class="se">\(</span><span class="n">response</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">count</span><span class="se">)</span><span class="s"> edges"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="n">response</span><span class="o">.</span><span class="n">items</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"</span><span class="se">\(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="se">)</span><span class="s"> [</span><span class="se">\(</span><span class="n">item</span><span class="o">.</span><span class="n">uuid</span><span class="se">)</span><span class="s"> "</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='リアルタイムデータのダウンストリームを行う' class='heading'>・リアルタイムデータのダウンストリームを行う</h3>

<p>1. <code><a href="Classes/IntdashClient.html">IntdashClient</a></code> を初期化する。<br>
2. 認証情報がセットされた <code><a href="Classes/IntdashClient/Session.html">IntdashClient.Session</a></code> をセットする。<br>
3. <code><a href="Classes/IntdashClient/DownstreamManager.html">IntdashClient.DownstreamManager</a></code> のデリゲートを設定する。<br>
4. intdashサーバーとの接続を開始する。<br>
5. ダウンストリームを開く。<br>
6. ダウンストリームフィルター(<code><a href="Classes/IntdashClient/DownstreamManager/RequestFilters.html">IntdashClient.DownstreamManager.RequestFilters</a></code>)を生成する。<br>
7. ダウンストリーム情報をintdashサーバーと同期する。  </p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">intdash</span><span class="p">:</span> <span class="kt">IntdashClient</span><span class="p">?</span>
<span class="k">var</span> <span class="nv">downstreamIds</span><span class="p">:</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]?</span>

<span class="c1">/// ダウンストリームを行う対象のエッジのUUID</span>
<span class="k">var</span> <span class="nv">downstreamTargetEdgeUuid</span> <span class="o">=</span> <span class="s">""</span> <span class="c1">// 必要に応じて変更</span>
<span class="c1">/// ダウンストリームを行う対象のエッジのチャンネル番号</span>
<span class="k">var</span> <span class="nv">targetChannel</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">// 必要に応じて変更</span>

<span class="kd">func</span> <span class="nf">startDownsteram</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 1. `IntdashClient` を初期化する。</span>
    <span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="p">()</span>
    <span class="c1">// 2. 認証情報がセットされた `IntdashClient.Session` をセットする。</span>
    <span class="n">intdash</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">session</span>
    <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="o">=</span> <span class="n">intdash</span>
    <span class="c1">// 3. `IntdashClient.DownstreamManager` のデリゲートを設定する。</span>
    <span class="n">intdash</span><span class="o">.</span><span class="n">downstreamManager</span><span class="o">.</span><span class="nf">addDelegate</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="c1">// IntdashClientDownstreamManagerDelegate</span>
    <span class="c1">// 4. intdashサーバーとの接続を開始する。</span>
    <span class="n">intdash</span><span class="o">.</span><span class="n">connect</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to connect to the intdash server. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="c1">// 5. ダウンストリームを開く。</span>
        <span class="k">let</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="n">streamId</span> <span class="o">=</span> <span class="k">try</span> <span class="n">intdash</span><span class="o">.</span><span class="n">downstreamManager</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="nv">srcEdgeId</span><span class="p">:</span> <span class="k">self</span><span class="o">!.</span><span class="n">downstreamTargetEdgeUuid</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to open downstream. </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">downstreamIds</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">downstreamIds</span> <span class="o">=</span> <span class="p">[</span><span class="n">streamId</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">downstreamIds</span><span class="p">?</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">streamId</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="c1">// 6. ダウンストリームフィルター(`IntdashClient.DownstreamManager.RequestFilters`)を生成する。</span>
        <span class="k">let</span> <span class="nv">downstreamFilter</span> <span class="o">=</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="nf">makeDownstreamFilters</span><span class="p">(</span><span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">,</span> <span class="nv">channel</span><span class="p">:</span> <span class="k">self</span><span class="o">!.</span><span class="n">targetChannel</span><span class="p">)</span>
        <span class="c1">// 7. ダウンストリーム情報をintdashサーバーと同期する。(※downstreamFiltersにnilを指定すると、全チャンネル、全データタイプ、全IDのデータを受信します)</span>
        <span class="n">intdash</span><span class="o">.</span><span class="n">downstreamManager</span><span class="o">.</span><span class="nf">sync</span><span class="p">(</span><span class="nv">completion</span><span class="p">:</span> <span class="p">{</span> <span class="p">(</span><span class="n">errors</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">errors</span> <span class="o">=</span> <span class="n">errors</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to request dowsntream. </span><span class="se">\(</span><span class="n">errors</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Success to downstream request."</span><span class="p">)</span>
        <span class="p">},</span> <span class="nv">filters</span><span class="p">:</span> <span class="n">downstreamFilter</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='ダウンストリームフィルターの生成方法' class='heading'>ダウンストリームフィルターの生成方法</h4>

<p>8. <code><a href="Classes/IntdashClient/DownstreamManager/RequestFilters.html">IntdashClient.DownstreamManager.RequestFilters</a></code> を初期化する。<br>
9. ダウンストリームするデータの情報を追加する。  </p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">makeDownstreamFilters</span><span class="p">(</span><span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">channel</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">DownstreamManager</span><span class="o">.</span><span class="kt">RequestFilters</span><span class="p">?</span> <span class="p">{</span>
    <span class="c1">// 8. `IntdashClient.DownstreamManager.RequestFilters` を初期化する。</span>
    <span class="k">let</span> <span class="nv">downstreamFilters</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">DownstreamManager</span><span class="o">.</span><span class="kt">RequestFilters</span><span class="p">()</span>

    <span class="c1">// 9. ダウンストリームするデータの情報を追加する。</span>
    <span class="c1">// フィルターが必要ない(全チャンネル、データを対象とする)場合は何もappendしない。</span>
    <span class="c1">// 「チャンネル1、データタイプGeneralSensor、ID 1,3,4」を追加する場合</span>
    <span class="n">downstreamFilters</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">,</span> <span class="nv">channelNum</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">dataType</span><span class="p">:</span> <span class="o">.</span><span class="n">generalSensor</span><span class="p">,</span> <span class="nv">ids</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
    <span class="c1">// 「チャンネル1、データタイプH.264、IDなし」を追加する場合</span>
    <span class="n">downstreamFilters</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">,</span> <span class="nv">channelNum</span><span class="p">:</span> <span class="n">channel</span><span class="p">,</span> <span class="nv">dataType</span><span class="p">:</span> <span class="o">.</span><span class="n">h264</span><span class="p">,</span> <span class="nv">id</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>

    <span class="c1">// フィルターが追加されなかった場合は全開放ファイルターとして扱われます。</span>
    <span class="k">return</span> <span class="n">downstreamFilters</span>
<span class="p">}</span>  
</code></pre>
<h4 id='ダウンストリームされたデータの取得方法' class='heading'>ダウンストリームされたデータの取得方法</h4>

<p>10. <code>IntdashClientDownstreamManagerDelegate.downstreamManagerDidParseDataPoints</code> から <code><a href="Structs/RealtimeDataPoint.html">RealtimeDataPoint</a></code> の配列を取得する。  </p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">ExampleViewController</span><span class="p">:</span> <span class="kt">IntdashClientDownstreamManagerDelegate</span> <span class="p">{</span>

    <span class="c1">// 10. `IntdashClientDownstreamManagerDelegate.downstreamManagerDidParseDataPoints` から `RealtimeDataPoint` の配列を取得する。</span>
    <span class="kd">func</span> <span class="nf">downstreamManagerDidParseDataPoints</span><span class="p">(</span><span class="n">_</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">DownstreamManager</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">dataPoints</span><span class="p">:</span> <span class="p">[</span><span class="kt">RealtimeDataPoint</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">for</span> <span class="n">dataPoint</span> <span class="k">in</span> <span class="n">dataPoints</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="n">dataPoint</span><span class="o">.</span><span class="n">dataModel</span><span class="o">.</span><span class="n">dataType</span> <span class="p">{</span>
                <span class="c1">// ...</span>
            <span class="k">default</span><span class="p">:</span> <span class="k">break</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
<h4 id='ダウンストリームを終了する' class='heading'>ダウンストリームを終了する</h4>

<p>11. ダウンストリームを閉じる。<br>
12. 閉じられているダウンストリームを削除する。<br>
13. intdashサーバーとの接続を終了する。(※終了する場合)  </p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">stopDownstream</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">let</span> <span class="nv">group</span> <span class="o">=</span> <span class="kt">DispatchGroup</span><span class="p">()</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">streamIds</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">downstreamIds</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">downstreamIds</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="n">group</span><span class="o">.</span><span class="nf">enter</span><span class="p">()</span>
        <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
            <span class="c1">// 11. ダウンストリームを閉じる。</span>
            <span class="n">intdash</span><span class="o">.</span><span class="n">downstreamManager</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="nv">streamIds</span><span class="p">:</span> <span class="n">streamIds</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to close downstream. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Success to close downstream."</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="c1">// 12. 閉じられたダウンストリームを削除する。</span>
                <span class="n">intdash</span><span class="o">.</span><span class="n">downstreamManager</span><span class="o">.</span><span class="nf">removeClosedDownstream</span><span class="p">()</span>
                <span class="n">group</span><span class="o">.</span><span class="nf">leave</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">group</span><span class="o">.</span><span class="nf">notify</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="o">.</span><span class="nf">global</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 13. intdashサーバーとの接続を終了する。(※終了する場合)</span>
        <span class="n">intdash</span><span class="o">.</span><span class="n">disconnect</span> <span class="p">{</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to disconnect to the intdash server. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Success to disconnect to the intdash server."</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h3 id='リアルタイムデータのアップストリームを行う-新しい計測を開始し-サーバーにリアルタイムデータを送信する' class='heading'>・リアルタイムデータのアップストリームを行う(新しい計測を開始し、サーバーにリアルタイムデータを送信する)</h3>

<p>1. <code><a href="Classes/IntdashClient.html">IntdashClient</a></code> を初期化する。<br>
2. 認証情報がセットされた <code><a href="Classes/IntdashClient/Session.html">IntdashClient.Session</a></code> をセットする。<br>
3. <code><a href="Classes/IntdashClient/UpstreamManager.html">IntdashClient.UpstreamManager</a></code> のデリゲートを設定する。(※セクション情報の管理やAckの確認を行いたい場合のみ)<br>
4. intdashサーバーとの接続を開始する。<br>
5. 計測IDを取得する。<br>
6. アップストリームを開く。<br>
7. アップストリーム情報をintdashサーバーと同期する。<br>
8. iOSデバイス内にデータを保存する場合は <code><a href="Classes/IntdashDataFileManager.html">IntdashDataFileManager</a></code> を初期化する。<br>
9. iOSデバイス内にデータを保存する場合は <code>IntdashDataFileManager.setMeasurementId()</code> で計測IDを保存する。  </p>
<pre class="highlight swift"><code><span class="c1">//var intdash: IntdashClient?</span>
<span class="k">var</span> <span class="nv">upstreamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">?</span>
<span class="k">var</span> <span class="nv">upstreamIds</span><span class="p">:</span> <span class="p">[</span><span class="kt">Int</span><span class="p">]?</span>

<span class="c1">/// アップストリームを行うチャンネル番号(※ストリームごとに別のチャンネル番号を設定することができます)</span>
<span class="c1">//var targetChannel: Int = 1 // 必要に応じて変更</span>

<span class="c1">/// iOSデバイス内にデータを保存する場合に使用するファイルマネージャー</span>
<span class="k">var</span> <span class="nv">intdashDataFileManager</span><span class="p">:</span> <span class="kt">IntdashDataFileManager</span><span class="p">?</span>
<span class="c1">/// intdashサーバーへ保存するかの選択</span>
<span class="k">var</span> <span class="nv">isSaveToServer</span><span class="p">:</span> <span class="kt">Bool</span> <span class="o">=</span> <span class="kc">true</span>
<span class="c1">/// intdashデータを保存するディレクトリのパス</span>
<span class="k">var</span> <span class="nv">intdashDataFileParentPath</span> <span class="o">=</span> <span class="kt">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="o">.</span><span class="n">documentDirectory</span><span class="p">,</span> <span class="o">.</span><span class="n">userDomainMask</span><span class="p">,</span> <span class="kc">true</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="kd">func</span> <span class="nf">startUpstream</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">edgeUuid</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">signInEdgeUuid</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="c1">// 1. `IntdashClient` を初期化する。</span>
    <span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="kt">IntdashClient</span><span class="p">()</span>
    <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="o">=</span> <span class="n">intdash</span>
    <span class="c1">// 2. 認証情報がセットされた `IntdashClient.Session` をセットする。</span>
    <span class="n">intdash</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">session</span>
    <span class="c1">// 3. IntdashClient.UpstreamManagerのデリゲートを設定する。(※セクション情報の管理やAckの確認を行いたい場合のみ)</span>
    <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">addDelegate</span><span class="p">(</span><span class="nv">delegate</span><span class="p">:</span> <span class="k">self</span><span class="p">)</span> <span class="c1">// IntdashClientUpstreamManagerDelegate</span>
    <span class="c1">// 4. intdashサーバーとの接続を開始する。</span>
    <span class="n">intdash</span><span class="o">.</span><span class="n">connect</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to connect to the intdash server. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="c1">// 5. 計測IDを取得する。</span>
        <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">requestMeasurementId</span><span class="p">(</span><span class="nv">edgeUuid</span><span class="p">:</span> <span class="n">edgeUuid</span><span class="p">)</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">measurementId</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">guard</span> <span class="k">let</span> <span class="nv">measurementId</span> <span class="o">=</span> <span class="n">measurementId</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to requestMeasurementId. </span><span class="se">\(</span><span class="n">error</span><span class="p">?</span><span class="o">.</span><span class="n">localizedDescription</span> <span class="p">??</span> <span class="s">""</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="c1">// 6. アップストリームを開く。</span>
            <span class="k">let</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span>
            <span class="k">do</span> <span class="p">{</span>
                <span class="c1">// データをサーバーに保存する場合は `store` を `true` にしてください。</span>
                <span class="n">streamId</span> <span class="o">=</span> <span class="k">try</span> <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="nv">measurementId</span><span class="p">:</span> <span class="n">measurementId</span><span class="p">,</span> <span class="nv">srcEdgeId</span><span class="p">:</span> <span class="n">edgeUuid</span><span class="p">,</span> <span class="nv">store</span><span class="p">:</span> <span class="k">self</span><span class="o">!.</span><span class="n">isSaveToServer</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to open upstream. </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">upstreamId</span> <span class="o">=</span> <span class="n">streamId</span>
            <span class="k">if</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">upstreamIds</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">upstreamIds</span> <span class="o">=</span> <span class="p">[</span><span class="n">streamId</span><span class="p">]</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">upstreamIds</span><span class="p">?</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">streamId</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="c1">// 7. アップストリーム情報をintdashサーバーと同期する。</span>
            <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="n">sync</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                    <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to request upstream. </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="k">return</span>
                <span class="p">}</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Success to request upstream."</span><span class="p">)</span>
                <span class="k">if</span> <span class="k">self</span><span class="o">!.</span><span class="n">isSaveToServer</span> <span class="p">{</span>
                    <span class="k">do</span> <span class="p">{</span>
                        <span class="c1">// 8. iOSデバイス内にデータを保存する場合は `IntdashDataFileManager` を初期化する。</span>
                        <span class="k">let</span> <span class="nv">fileManager</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">IntdashDataFileManager</span><span class="p">(</span><span class="nv">parentPath</span><span class="p">:</span> <span class="s">"</span><span class="se">\(</span><span class="k">self</span><span class="o">!.</span><span class="n">intdashDataFileParentPath</span><span class="se">)</span><span class="s">/</span><span class="se">\(</span><span class="n">measurementId</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                        <span class="c1">// 9. iOSデバイス内にデータを保存する場合は `IntdashDataFileManager.setMeasurementId()` で計測IDを保存する。</span>
                        <span class="k">try</span> <span class="n">fileManager</span><span class="o">.</span><span class="nf">setMeasurementId</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="n">measurementId</span><span class="p">)</span>
                        <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">intdashDataFileManager</span> <span class="o">=</span> <span class="n">fileManager</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
                        <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to setup file manager. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ExampleViewController</span><span class="p">:</span> <span class="kt">IntdashClientUpstreamManagerDelegate</span> <span class="p">{</span>

    <span class="kd">func</span> <span class="nf">upstreamManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">UpstreamManager</span><span class="p">,</span> <span class="n">didGeneratedSesion</span> <span class="nv">sectionId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">sectionIndex</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">final</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">sentCount</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">startOfElapsedTime</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">,</span> <span class="nv">endOfElapsedTime</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">upstreamManager</span><span class="p">(</span><span class="n">_</span> <span class="nv">manager</span><span class="p">:</span> <span class="kt">IntdashClient</span><span class="o">.</span><span class="kt">UpstreamManager</span><span class="p">,</span> <span class="n">didReceiveEndOfSection</span> <span class="nv">sectionId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">success</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">final</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="nv">sentCount</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
<h4 id='アップストリームするデータの送信' class='heading'>アップストリームするデータの送信</h4>

<p>10. iOSデバイス内にデータを保存する場合は、計測開始時刻を <code>IntdashDataFileManager.setBaseTime()</code> で保存しておく。<br>
11. 基準となる計測開始時刻を <code>IntdashClient.UpstreamManager.sendFirstData()</code> で送信する。<br>
12. 送信したいデータを、 <code><a href="Classes/IntdashData.html">IntdashData</a></code> のサブクラスでラップする。<br>
13. iOSデバイス内にデータを保存する場合は <code><a href="Classes/IntdashDataFileManager.html#/s:7Intdash0A15DataFileManagerC5writeyyKF">IntdashDataFileManager.write()</a></code> でデータを保存する。<br>
14. 生成したデータを <code>IntdashClient.UpstreamManager.sendUnit()</code> で送信する。<br>
15. 12、(13)、14を任意の時間または回数だけ繰り返す。  </p>
<pre class="highlight swift"><code><span class="k">var</span> <span class="nv">baseTime</span><span class="p">:</span> <span class="kt">TimeInterval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="kd">func</span> <span class="nf">sendFirstData</span><span class="p">(</span><span class="nv">baseTime</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">channel</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">baseTime</span> <span class="o">=</span> <span class="n">baseTime</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// 10. iOSデバイス内にデータを保存する場合は、計測開始時刻を `IntdashDataFileManager.setBaseTime()` で保存しておく。</span>
        <span class="k">try</span> <span class="k">self</span><span class="o">.</span><span class="n">intdashDataFileManager</span><span class="p">?</span><span class="o">.</span><span class="nf">setBaseTime</span><span class="p">(</span><span class="nv">time</span><span class="p">:</span> <span class="n">baseTime</span><span class="p">)</span>
        <span class="c1">// 11. 基準となる計測開始時間を `IntdashClient.UpstreamManager.sendFirstData()` で送信する。</span>
        <span class="k">try</span> <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">sendFirstData</span><span class="p">(</span><span class="n">baseTime</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">,</span> <span class="nv">channelNum</span><span class="p">:</span> <span class="n">channel</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to send first data. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">generateData</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">streamId</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">upstreamId</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">let</span> <span class="nv">timestamp</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSince1970</span>
    <span class="k">if</span> <span class="k">self</span><span class="o">.</span><span class="n">baseTime</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="nf">sendFirstData</span><span class="p">(</span><span class="nv">baseTime</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">,</span> <span class="nv">channel</span><span class="p">:</span> <span class="k">self</span><span class="o">.</span><span class="n">targetChannel</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">let</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="c1">// 12. 送信したいデータを、 `IntdashData` のサブクラスでラップする。</span>
    <span class="c1">// データの種別に関しては「詳説iSCP 1.0」を参照してください。</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span><span class="p">?</span> <span class="kt">IntdashData</span><span class="o">.</span><span class="kt">DataInt</span><span class="p">(</span><span class="nv">id</span><span class="p">:</span> <span class="s">"intdash-data-example-id"</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="kt">Int64</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">self</span><span class="o">.</span><span class="nf">sendData</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">,</span> <span class="nv">timestamp</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">sendData</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">IntdashData</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="nv">timestamp</span><span class="p">:</span> <span class="kt">TimeInterval</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">let</span> <span class="nv">elapsedTime</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="k">self</span><span class="o">.</span><span class="n">baseTime</span>
    <span class="k">guard</span> <span class="n">elapsedTime</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="c1">// 13. iOSデバイス内にデータを保存する場合は `IntdashDataFileManager.write()` でデータを保存する。</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">fileManager</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">intdashDataFileManager</span> <span class="p">{</span>
                <span class="k">if</span> <span class="k">let</span> <span class="nv">fileManager</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">intdashDataFileManager</span> <span class="p">{</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="k">try</span> <span class="n">fileManager</span><span class="o">.</span><span class="nf">write</span><span class="p">(</span><span class="nv">units</span><span class="p">:</span> <span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="nv">elapsedTime</span><span class="p">:</span> <span class="n">elapsedTime</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="c1">// 14. 生成したデータを`IntdashClient.UpstreamManager.sendUnit()` で送信する。</span>
            <span class="k">try</span> <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">sendUnit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nv">elapsedTime</span><span class="p">:</span> <span class="n">elapsedTime</span><span class="p">,</span> <span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to send data. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h4 id='アップストリーム-計測-を終了する' class='heading'>アップストリーム(計測)を終了する。</h4>

<p>16. iOSデバイスにデータを保存している場合は、計測時間を <code>IntdashDataFileManager.setDuration()</code> で保存する。<br>
17. 計測の終了を示すデータを送信する。<br>
18. アップストリームを閉じる。<br>
19. 閉じられているアップストリームを削除する。<br>
20. intdashサーバーとの接続を終了する。(※終了する場合)  </p>
<pre class="highlight swift"><code><span class="kd">func</span> <span class="nf">stopUpstream</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">intdash</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">self</span><span class="o">.</span><span class="n">intdash</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="c1">// 16. iOSデバイスにデータを保存している場合は、計測時間を `IntdashDataFileManager.setDuration()` で保存する。</span>
    <span class="k">let</span> <span class="nv">now</span> <span class="o">=</span> <span class="kt">Date</span><span class="p">()</span><span class="o">.</span><span class="n">timeIntervalSince1970</span> <span class="c1">// 時間管理をDate()で行っている場合</span>
    <span class="k">let</span> <span class="nv">duration</span> <span class="o">=</span> <span class="n">now</span><span class="o">-</span><span class="k">self</span><span class="o">.</span><span class="n">baseTime</span>
    <span class="k">try</span><span class="p">?</span> <span class="k">self</span><span class="o">.</span><span class="n">intdashDataFileManager</span><span class="p">?</span><span class="o">.</span><span class="nf">setDuration</span><span class="p">(</span><span class="nv">duration</span><span class="p">:</span> <span class="n">duration</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">intdashDataFileManager</span> <span class="o">=</span> <span class="kc">nil</span>

    <span class="k">let</span> <span class="nv">group</span> <span class="o">=</span> <span class="kt">DispatchGroup</span><span class="p">()</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">streamId</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">upstreamId</span> <span class="p">{</span>
        <span class="k">self</span><span class="o">.</span><span class="n">upstreamId</span> <span class="o">=</span> <span class="kc">nil</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="c1">// 17. 計測の終了を示すデータを送信する。</span>
            <span class="k">try</span> <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">sendLastData</span><span class="p">(</span><span class="nv">streamId</span><span class="p">:</span> <span class="n">streamId</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to send last data. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="k">let</span> <span class="nv">streamIds</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">upstreamIds</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">upstreamIds</span> <span class="o">=</span> <span class="kc">nil</span>
            <span class="n">group</span><span class="o">.</span><span class="nf">enter</span><span class="p">()</span>
            <span class="kt">DispatchQueue</span><span class="o">.</span><span class="nf">global</span><span class="p">()</span><span class="o">.</span><span class="n">async</span> <span class="p">{</span>
                <span class="c1">// 18. アップストリームを閉じる。</span>
                <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">close</span><span class="p">(</span><span class="nv">streamIds</span><span class="p">:</span> <span class="n">streamIds</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
                    <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                        <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to close upstream. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="nf">print</span><span class="p">(</span><span class="s">"Success to close upstream."</span><span class="p">)</span>
                    <span class="p">}</span>
                    <span class="c1">// 19. 閉じられているアップストリームを削除する。</span>
                    <span class="n">intdash</span><span class="o">.</span><span class="n">upstreamManager</span><span class="o">.</span><span class="nf">removeClosedUpstream</span><span class="p">()</span>
                    <span class="n">group</span><span class="o">.</span><span class="nf">leave</span><span class="p">()</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">group</span><span class="o">.</span><span class="nf">notify</span><span class="p">(</span><span class="nv">queue</span><span class="p">:</span> <span class="o">.</span><span class="nf">global</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// 20. intdashサーバーとの接続を終了する。(※終了する場合)</span>
        <span class="n">intdash</span><span class="o">.</span><span class="n">disconnect</span> <span class="p">{</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">in</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to disconnect to the intdash server. </span><span class="se">\(</span><span class="n">error</span><span class="o">.</span><span class="n">localizedDescription</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nf">print</span><span class="p">(</span><span class="s">"Success to disconnect to the intdash server."</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<h2 id='使用している外部ライブラリ' class='heading'>■ 使用している外部ライブラリ</h2>

<ul>
<li><a href="https://github.com/tidwall/SwiftWebSocket/blob/master/Source/WebSocket.swift">SwiftWebSocket</a>

<ul>
<li>ライセンス：MIT</li>
</ul></li>
</ul>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2021 <a class="link" href="https://www.aptpod.co.jp" target="_blank" rel="external">aptpod Inc</a>. All rights reserved. (Last updated: 2021-06-01)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.6</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
